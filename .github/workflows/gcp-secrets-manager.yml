name: "GCP Secrets Manager Sync"

on:
  workflow_dispatch:
    # Manual trigger to sync secrets
  schedule:
    # Daily sync at 2 AM UTC
    - cron: "0 2 * * *"
  push:
    branches: [ main ]
    paths:
      - "terraform/gcp/secrets.tf"
      - ".github/workflows/gcp-secrets-manager.yml"

permissions:
  contents: read
  id-token: write

env:
  TF_CLOUD_ORGANIZATION: "lornu-ai"
  TF_API_TOKEN: ${{ secrets.GCP_TF_API_TOKEN }}
  TF_WORKSPACE: "gcp-lornu-ai"
  CONFIG_DIRECTORY: "./terraform/gcp"

jobs:
  sync-secrets:
    name: "Sync Secrets to GCP Secret Manager"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Authenticate to Google Cloud"
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}

      - name: "Set up Cloud SDK"
        uses: google-github-actions/setup-gcloud@v3

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "~> 1.6"
          cli_config_credentials_token: ${{ env.TF_API_TOKEN }}

      - name: "Terraform Init"
        run: |
          cd ${{ env.CONFIG_DIRECTORY }}
          terraform init -upgrade

      - name: "Terraform Plan (Secrets)"
        env:
          TF_VAR_resend_api_key: ${{ secrets.RESEND_API_KEY }}
        run: |
          cd ${{ env.CONFIG_DIRECTORY }}
          terraform plan \
            -target=google_secret_manager_secret.resend_api_key \
            -target=google_secret_manager_secret_iam_member.resend_api_key_access \
            -out=secrets.tfplan

      - name: "Terraform Apply (Secrets)"
        if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          TF_VAR_resend_api_key: ${{ secrets.RESEND_API_KEY }}
        run: |
          cd ${{ env.CONFIG_DIRECTORY }}
          terraform apply -auto-approve secrets.tfplan

      - name: "Add Secret Version (via gcloud)"
        if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          SECRET_VALUE: ${{ secrets.RESEND_API_KEY }}
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          echo -n "$SECRET_VALUE" | gcloud secrets versions add resend-api-key \
            --data-file=- \
            --project=$PROJECT_ID

      - name: "Output Secret Info"
        env:
          PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
        run: |
          echo "âœ… Secrets synced to GCP Secret Manager:"
          echo "Secret ID: resend-api-key"
          echo "Project: $PROJECT_ID"
          gcloud secrets describe resend-api-key --project=$PROJECT_ID --format="value(name)"

