name: GCP Terraform Drift Check

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: read
  issues: write

env:
  TF_CLOUD_ORGANIZATION: "lornu-ai"
  TF_WORKSPACE: "gcp-lornu-ai"
  TF_VERSION: "1.14"

jobs:
  drift-check:
    name: Check for Infrastructure Drift
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_CREDENTIALS_JSON }}
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}
          cli_config_credentials_token: ${{ secrets.GCP_TF_API_TOKEN }}

      - name: Terraform Init
        run: terraform -chdir=terraform/gcp init

      - name: Terraform Plan (Drift Detection)
        id: plan
        run: |
          terraform -chdir=terraform/gcp plan -detailed-exitcode -no-color -var="project_id=${{ secrets.GCP_PROJECT_ID }}"
        env:
          GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS_JSON }}
        continue-on-error: true

      - name: Post Drift Notification
        if: steps.plan.outputs.exitcode == '2'
        uses: actions/github-script@v7
        with:
          script: |
            const output = `### ‚ö†Ô∏è Infrastructure Drift Detected
            Manual changes have been detected in the GCP environment that are not reflected in Terraform.

            **Action Required:**
            1. Review the logs for this run to see the detected changes.
            2. Update the Terraform code to match the desired state or revert manual changes.

            Run ID: ${{ github.run_id }}`;

            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.name,
              title: 'üö® GCP Infrastructure Drift Detected',
              body: output,
              labels: ['drift', 'infrastructure']
            });
