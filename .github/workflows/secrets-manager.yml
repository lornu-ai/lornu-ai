name: "Secrets Manager Sync"

on:
  workflow_dispatch:
    # Manual trigger to sync secrets
  schedule:
    # Daily sync at 2 AM UTC
    - cron: "0 2 * * *"
  push:
    branches: [ kustomize ]
    paths:
      - "terraform/aws/production/secrets-manager.tf"
      - "terraform/aws/production/secrets-variables.tf"
      - ".github/workflows/secrets-manager.yml"

permissions:
  contents: read
  id-token: write

jobs:
  sync-secrets:
    name: "Sync Secrets to AWS Secrets Manager"
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Configure AWS Credentials"
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ACTIONS_PROD_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: "Setup Terraform"
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: "~> 1.6"

      - name: "Terraform Init"
        run: |
          cd terraform/aws/production
          terraform init -upgrade

      - name: "Terraform Plan (Secrets)"
        env:
          TF_VAR_resend_api_key: ${{ secrets.RESEND_API_KEY }}
        run: |
          cd terraform/aws/production
          terraform plan \
            -target=aws_secretsmanager_secret.resend_api_key \
            -target=aws_secretsmanager_secret_version.resend_api_key \
            -out=secrets.tfplan

      - name: "Terraform Apply (Secrets)"
        if: github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          TF_VAR_resend_api_key: ${{ secrets.RESEND_API_KEY }}
        run: |
          cd terraform/aws/production
          terraform apply -auto-approve secrets.tfplan

      - name: "Output Secret ARNs"
        run: |
          cd terraform/aws/production
          echo "âœ… Secrets synced to AWS Secrets Manager:"
          terraform output -raw resend_api_key_secret_arn
          terraform output -raw resend_api_key_secret_name
