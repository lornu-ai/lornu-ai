name: "Intelligent IaC Orchestrator"

on:
  push:
    branches: [ develop, main ]
    paths:
      - 'terraform/aws/environments/**'
  pull_request:
    branches: [ develop, main ]
    paths:
      - 'terraform/aws/environments/**'

permissions:
  contents: read
  id-token: write

jobs:
  filter:
    name: "Filter Environments"
    runs-on: ubuntu-latest
    outputs:
      workspaces: ${{ steps.set-matrix.outputs.workspaces }}
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Get Changed Directories"
        id: changed-dirs
        uses: tj-actions/changed-files@v42
        with:
          dir_names: true
          files: |
            terraform/aws/environments/**

      - name: "Set Workspace Matrix"
        id: set-matrix
        run: |
          # Transform paths like 'terraform/aws/environments/production'
          # into workspace suffixes: ['production']
          # We filter the list to only include immediate subdirectories of environments/
          ALL_DIRS="${{ steps.changed-dirs.outputs.all_changed_files }}"
          echo "Changed files: $ALL_DIRS"

          # Logic to extract the environment name
          # Example: terraform/aws/environments/production/main.tf -> production
          DIRS=$(echo "$ALL_DIRS" | tr ' ' '\n' | grep '^terraform/aws/environments/' | sed 's|terraform/aws/environments/||g' | cut -d'/' -f1 | sort -u | jq -R . | jq -s -c .)

          echo "Detected environments: $DIRS"
          echo "workspaces=$DIRS" >> $GITHUB_OUTPUT

  orchestrate:
    name: "TFC Orchestrator"
    needs: filter
    if: needs.filter.outputs.workspaces != '[]' && needs.filter.outputs.workspaces != ''
    strategy:
      max-parallel: 3
      matrix:
        workspace_suffix: ${{ fromJson(needs.filter.outputs.workspaces) }}
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Bootstrap Workspace"
        run: |
          chmod +x terraform/tfc-management/bootstrap.sh
          # Extract role_arn for the current workspace_suffix from workspaces.tfvars
          # This is a robust way to sync bootstrap with Hub settings
          ROLE_ARN=$(grep -A 15 "\"${{ matrix.workspace_suffix }}\" =" terraform/tfc-management/workspaces.tfvars | grep "role_arn" | cut -d'"' -f2)
          echo "Bootstrapping with role: $ROLE_ARN"
          ./terraform/tfc-management/bootstrap.sh "${{ secrets.TF_CLOUD_ORG }}" "lornu-ai-${{ matrix.workspace_suffix }}" "${{ secrets.TF_API_TOKEN }}" "$ROLE_ARN"

      - name: "Upload Configuration"
        uses: hashicorp/tfc-workflows-github/actions/upload-configuration@v1.3.2
        id: upload
        with:
          workspace: "lornu-ai-${{ matrix.workspace_suffix }}"
          directory: "terraform/aws/environments/${{ matrix.workspace_suffix }}"
          organization: ${{ secrets.TF_CLOUD_ORG }}
          token: ${{ secrets.TF_API_TOKEN }}

      - name: "Trigger TFC Run"
        uses: hashicorp/tfc-workflows-github/actions/create-run@v1.3.2
        id: create-run
        with:
          token: ${{ secrets.TF_API_TOKEN }}
          organization: ${{ secrets.TF_CLOUD_ORG }}
          workspace: "lornu-ai-${{ matrix.workspace_suffix }}"
          configuration_version: ${{ steps.upload.outputs.configuration_version_id }}
          plan_only: ${{ github.event_name == 'pull_request' }}
          message: "Orchestrated Apply - Lornu AI Build: ${{ github.sha }}"

      - name: "Wait for TFC Run and Fetch Outputs"
        if: github.event_name != 'pull_request'
        run: |
          echo "Run ID: ${{ steps.create-run.outputs.run_id }}"
          # In a real scenario, we would use the TFC CLI or API to wait and fetch outputs.
          # For now, we log the intent as per the Phase 4 roadmap.
          echo "Phase 4: Fetching eks_cluster_name and oidc_provider_arn for ${{ matrix.workspace_suffix }}"

  deploy:
    name: "K8s Deployment"
    needs: [filter, orchestrate]
    if: github.event_name != 'pull_request' && needs.filter.outputs.workspaces != '[]'
    strategy:
      matrix:
        workspace_suffix: ${{ fromJson(needs.filter.outputs.workspaces) }}
    runs-on: ubuntu-latest
    steps:
      - name: "Checkout"
        uses: actions/checkout@v4

      - name: "Deploy to EKS"
        run: |
          echo "Deploying to EKS cluster for ${{ matrix.workspace_suffix }}"
          # Here we would use the outputs from TFC to update kubeconfig and run Kustomize.
          # Example:
          # aws eks update-kubeconfig --name ${{ env.EKS_CLUSTER_NAME }}
          # kustomize build k8s/overlays/${{ matrix.workspace_suffix }} | kubectl apply -f -
