name: "Stage 1: ACM Certificate + Route53 Zone"

# =============================================================================
# STAGE 1: Create ACM certificate with DNS validation
# =============================================================================
# This workflow creates:
#   - Route53 hosted zone (if create_route53_zone = true)
#   - ACM certificate with DNS validation
#   - DNS CNAME records for certificate validation
#   - Waits for certificate to be issued (~5-15 minutes)
#
# Run this FIRST before Stage 2. After this completes successfully,
# the ACM certificate will be in ISSUED state and ready for CloudFront.
# =============================================================================

on:
  workflow_dispatch:
    inputs:
      apply:
        description: 'Apply changes (true) or just plan (false)'
        required: true
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_DEFAULT_REGION }}

jobs:
  stage1-acm:
    name: ACM Certificate Setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ACTIONS_PROD_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.8.0
          cli_config_credentials_token: ${{ secrets.AWS_TF_API_TOKEN }}

      - name: Terraform Init
        run: terraform -chdir=terraform/aws/production init

      - name: Terraform Plan (Stage 1)
        env:
          TF_VAR_deploy_stage: "1"
          TF_VAR_secrets_manager_arn_pattern: ${{ secrets.SECRETS_MANAGER_ARN_PATTERN }}
          TF_VAR_docker_image: "placeholder:latest"
          TF_VAR_domain_name: ${{ secrets.PROD_DOMAIN }}
          TF_VAR_api_domain: ${{ secrets.PROD_API_DOMAIN }}
          TF_VAR_db_username: ${{ secrets.PROD_DB_USERNAME }}
          TF_VAR_db_password: ${{ secrets.PROD_DB_PASSWORD }}
          TF_VAR_route53_zone_name: ${{ secrets.ROUTE53_ZONE_NAME }}
          TF_VAR_create_route53_zone: "true"
          TF_VAR_existing_acm_certificate_arn: ${{ secrets.PROD_ACM_CERTIFICATE_ARN }}
        run: |
          echo "üîê Stage 1: Creating ACM certificate with DNS validation"
          echo "   This will create:"
          echo "   - Route53 hosted zone"
          echo "   - ACM certificate"
          echo "   - DNS validation records"
          echo ""
          terraform -chdir=terraform/aws/production plan -out=tfplan

      - name: Terraform Apply (Stage 1)
        if: inputs.apply == 'true'
        env:
          TF_VAR_deploy_stage: "1"
          TF_VAR_secrets_manager_arn_pattern: ${{ secrets.SECRETS_MANAGER_ARN_PATTERN }}
          TF_VAR_docker_image: "placeholder:latest"
          TF_VAR_domain_name: ${{ secrets.PROD_DOMAIN }}
          TF_VAR_api_domain: ${{ secrets.PROD_API_DOMAIN }}
          TF_VAR_db_username: ${{ secrets.PROD_DB_USERNAME }}
          TF_VAR_db_password: ${{ secrets.PROD_DB_PASSWORD }}
          TF_VAR_route53_zone_name: ${{ secrets.ROUTE53_ZONE_NAME }}
          TF_VAR_create_route53_zone: "true"
          TF_VAR_existing_acm_certificate_arn: ${{ secrets.PROD_ACM_CERTIFICATE_ARN }}
        run: |
          echo "üöÄ Applying Stage 1..."
          echo "   Certificate validation typically takes 5-15 minutes."
          terraform -chdir=terraform/aws/production apply -auto-approve tfplan

      - name: Verify Certificate Status
        if: inputs.apply == 'true'
        run: |
          echo "‚úÖ Stage 1 complete!"
          echo ""
          echo "üìã Next steps:"
          echo "   1. Verify the ACM certificate is in ISSUED state in AWS Console"
          echo "   2. Run Stage 2 workflow to create CloudFront distribution"
          echo ""
          echo "üîó Check certificate status:"
          echo "   aws acm list-certificates --region us-east-1"
